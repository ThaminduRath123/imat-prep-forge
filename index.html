<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMAT Prep Forge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for smooth effects and typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Lighter slate background */
        }
        .scrollable-content {
            /* Ensures content fits below the fixed header */
            min-height: calc(100vh - 8rem);
        }
        /* Custom pulse animation for better compatibility */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
        .animate-pulse-ring {
            animation: pulse-ring 1.5s infinite;
        }
        .question-card {
            transition: box-shadow 0.3s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
        }
        /* Style for the fixed mock exam header */
        .mock-header {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.95);
        }
        .nav-link.active {
            color: #4f46e5;
            font-weight: 700;
            border-bottom: 3px solid #4f46e5;
        }
    </style>
</head>
<body class="min-h-screen antialiased flex flex-col">

    <!-- Header & Navigation -->
    <header id="app-header" class="bg-white shadow-lg sticky top-0 z-10">
        <!-- Content replaced by renderApp if in Mock Exam mode -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="window.navigate('dashboard')">
                    <i data-lucide="sparkles" class="text-indigo-600 h-8 w-8"></i>
                    <h1 class="text-2xl font-extrabold text-gray-800">IMAT <span class="text-indigo-600">Prep</span> Forge</h1>
                </div>
                <div id="nav-container" class="flex space-x-6">
                    <!-- Nav links inserted here by JS -->
                </div>
                <div id="auth-status" class="text-sm text-gray-500 hidden sm:block">
                    Loading Auth...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full">
        <!-- Message Box -->
        <div id="message-box" class="fixed top-20 right-4 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-300 opacity-0 hidden font-semibold"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-white/95 backdrop-blur-sm z-50 flex items-center justify-center hidden">
            <div class="flex flex-col items-center p-10 bg-white rounded-3xl shadow-2xl border border-indigo-100">
                <div id="loading-spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-6"></div>
                <h3 class="text-2xl font-extrabold text-gray-800 mb-2">AI is Generating Your Content...</h3>
                <p id="loading-text" class="text-indigo-600 text-lg font-medium animate-pulse">Crafting 60 unique questions, please wait.</p>
            </div>
        </div>

        <!-- Main View Container -->
        <div id="app-view" class="p-4 sm:p-6 lg:p-8 scrollable-content">
            <!-- Content will be rendered here -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-3">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>&copy; 2025 IMAT Prep Forge. Practice powered by Gemini API. User ID: <span id="footer-user-id">N/A</span></p>
        </div>
    </footer>

    <!-- Firebase and Application Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. CONFIGURATION AND INITIALIZATION ---
        
        // MANDATORY GLOBALS
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        setLogLevel('Debug');
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const EXAM_DEFAULT_DATE = new Date(new Date().setMonth(new Date().getMonth() + 3)); // 3 months from now
        
        const STATE = {
            currentPage: 'dashboard',
            userData: {
                examDate: EXAM_DEFAULT_DATE.toISOString().split('T')[0], // YYYY-MM-DD
                mockScores: [],
                studyPlan: []
            },
            currentMock: null, // Holds questions, userAnswers, startTime, timeLeft, isFinished, type
            currentQuestionIndex: 0, // NEW: Tracks the current question in the mock/quiz view
            loading: false
        };

        const IMAT_SECTIONS = [
            { name: "General Knowledge", count: 4, weight: 1 },
            { name: "Logical Reasoning", count: 5, weight: 1 },
            { name: "Biology", count: 23, weight: 3 },
            { name: "Chemistry", count: 15, weight: 2 },
            { name: "Physics & Mathematics", count: 13, weight: 2 }
        ];
        const TOTAL_IMAT_QUESTIONS = IMAT_SECTIONS.reduce((sum, s) => sum + s.count, 0);

        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;

        // --- PRE-GENERATED QUIZ DATA ---
        // Used for instant, untimed quizzes (no AI call needed)
        const PRE_GENERATED_QUIZ_QUESTIONS = [
            { id: 'PQ1', questionText: 'Which organelle is responsible for ATP production?', section: 'Biology', options: { A: 'Ribosome', B: 'ER', C: 'Mitochondrion', D: 'Lysosome', E: 'Golgi' }, correctAnswer: 'C', explanation: 'The Mitochondrion is the powerhouse of the eukaryotic cell. It is the site of cellular respiration, which produces the most ATP (energy) from glucose.' },
            { id: 'PQ2', questionText: 'What is the primary function of DNA ligase in molecular biology?', section: 'Biology', options: { A: 'Unwind DNA', B: 'Synthesize new strands', C: 'Separate fragments', D: 'Join Okazaki fragments', E: 'Remove introns' }, correctAnswer: 'D', explanation: 'DNA ligase acts as molecular glue, specifically joining the small DNA segments (Okazaki fragments) created during replication of the lagging strand into a continuous strand.' },
            { id: 'PQ3', questionText: 'Molarity of 20g NaOH (40 g/mol) in 500 mL water?', section: 'Chemistry', options: { A: '0.5 M', B: '1.0 M', C: '1.5 M', D: '2.0 M', E: '4.0 M' }, correctAnswer: 'B', explanation: 'Moles = 20g / 40 g/mol = 0.5 moles. Molarity = 0.5 moles / 0.5 L = 1.0 M.' },
            { id: 'PQ4', questionText: 'Which bond involves complete transfer of valence electron(s)?', section: 'Chemistry', options: { A: 'Covalent bond', B: 'Hydrogen bond', C: 'Metallic bond', D: 'Ionic bond', E: 'Polar covalent bond' }, correctAnswer: 'D', explanation: 'An Ionic bond is formed when one atom completely transfers one or more electrons to another, resulting in attractive electrostatic forces between oppositely charged ions.' },
            { id: 'PQ5', questionText: 'Argument: All successful doctors studied diligently. Jane is a successful doctor. Therefore, Jane studied diligently. Logical structure?', section: 'Logical Reasoning', options: { A: 'Sampling error.', B: 'Valid syllogism (Modus Ponens).', C: 'Affirming the consequent.', D: 'Conclusion doesn\'t follow.', E: 'Analogy.' }, correctAnswer: 'B', explanation: 'This argument follows the structure of Modus Ponens (If P, then Q. P. Therefore, Q), which is a valid form of deductive reasoning.' },
            { id: 'PQ6', questionText: 'What most weakens: "City should stop funding library; online resources make books obsolete."', section: 'Logical Reasoning', options: { A: 'Online resources are expensive.', B: 'Library provides computer access & job training.', C: 'Students prefer physical textbooks.', D: 'Building is historical landmark.', E: 'Park budget is being cut.' }, correctAnswer: 'B', explanation: 'The argument assumes the library\'s *only* function is providing books. Showing the library offers crucial non-book services directly attacks and weakens the premise for defunding.' },
            { id: 'PQ7', questionText: 'Car accelerates from rest to 20 m/s in 5s. What is the acceleration?', section: 'Physics & Mathematics', options: { A: '4 m/s^2', B: '5 m/s^2', C: '100 m/s^2', D: '0.25 m/s^2', E: '20 m/s^2' }, correctAnswer: 'A', explanation: 'Acceleration (a) = Δv / Δt = 20 m/s / 5 s = 4 m/s^2.' },
            { id: 'PQ8', questionText: 'If 3^x = 81, what is x?', section: 'Physics & Mathematics', options: { A: '2', B: '3', C: '4', D: '27', E: '81' }, correctAnswer: 'C', explanation: 'Since 3 * 3 * 3 * 3 = 81, then 3^4 = 81. Therefore, x=4.' },
            { id: 'PQ9', questionText: 'Which organization publishes the Human Development Index (HDI)?', section: 'General Knowledge', options: { A: 'WHO', B: 'UNDP', C: 'IMF', D: 'World Bank', E: 'UNICEF' }, correctAnswer: 'B', explanation: 'The United Nations Development Programme (UNDP) is the agency responsible for calculating and publishing the Human Development Index (HDI).' },
            { id: 'PQ10', questionText: 'The concept of "separation of powers" is attributed to which philosopher?', section: 'General Knowledge', options: { A: 'Rousseau', B: 'Voltaire', C: 'Kant', D: 'Montesquieu', E: 'Locke' }, correctAnswer: 'D', explanation: 'Baron de Montesquieu, specifically in his work The Spirit of the Laws, detailed the concept of separating government powers to prevent tyranny.' }
        ];

        // --- 2. UTILITIES ---

        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            box.innerHTML = message;
            
            let typeClass = 'bg-green-500 text-white';
            if (type === 'error') typeClass = 'bg-red-600 text-white';
            if (type === 'info') typeClass = 'bg-blue-600 text-white';

            box.className = `fixed top-20 right-4 p-4 rounded-xl shadow-2xl z-50 transition-opacity duration-300 opacity-100 block ${typeClass}`;
            
            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 5000);
        }

        function setLoading(isLoading, message = "AI is generating your questions...") {
            STATE.loading = isLoading;
            const overlay = document.getElementById('loading-overlay');
            const loadText = document.getElementById('loading-text');

            if (isLoading) {
                overlay.classList.remove('hidden');
                loadText.textContent = message;
            } else {
                overlay.classList.add('hidden');
            }
            renderApp();
        }

        function calculateScore(mockData) {
            let correct = 0;
            let incorrect = 0;
            let omitted = 0;
            let totalScore = 0;

            mockData.questions.forEach(q => {
                const userChoice = mockData.userAnswers[q.id];
                if (!userChoice) {
                    omitted++;
                } else if (userChoice === q.correctAnswer) {
                    correct++;
                    totalScore += 1.5;
                } else {
                    incorrect++;
                    totalScore -= 0.4;
                }
            });

            return { correct, incorrect, omitted, totalScore: totalScore.toFixed(2) };
        }
        
        // --- 3. FIREBASE & DATA MANAGEMENT ---

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Data persistence will not work.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('auth-status').textContent = `Status: Logged In`;
                        document.getElementById('footer-user-id').textContent = userId;
                        startDataListeners();
                    } else {
                        document.getElementById('auth-status').textContent = `Status: Guest`;
                        document.getElementById('footer-user-id').textContent = 'N/A';
                        isAuthReady = true;
                        setLoading(false);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('auth-status').textContent = `Status: Error`;
                isAuthReady = true;
                setLoading(false);
                showMessage("Database error. Your progress might not be saved.", 'error');
            }
        }
        
        function getPrivateDocRef(docName) {
            if (!userId || !db) return null;
            // Path: /artifacts/{appId}/users/{userId}/settings/{docName}
            return doc(db, 'artifacts', appId, 'users', userId, 'settings', docName);
        }

        function startDataListeners() {
            if (!isAuthReady || !userId) return;

            // Listen for User Data (Exam Date, Study Plan)
            const userDocRef = getPrivateDocRef('imat_user_data');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    STATE.userData.examDate = data.examDate || EXAM_DEFAULT_DATE.toISOString().split('T')[0];
                    STATE.userData.studyPlan = data.studyPlan || [];
                }
                setLoading(false);
                renderApp();
            }, (error) => {
                console.error("Error listening to user data:", error);
                showMessage("Could not load user data.", 'error');
                setLoading(false);
                renderApp();
            });

            // Listen for Mock Scores
            const scoresCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'mock_scores');
            onSnapshot(scoresCollectionRef, (snapshot) => {
                STATE.userData.mockScores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    // Convert Firestore timestamp to Date object for sorting/display
                    timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date(), 
                    ...doc.data()
                })).sort((a, b) => b.timestamp - a.timestamp); // Newest first
                renderApp();
            }, (error) => {
                console.error("Error listening to mock scores:", error);
                showMessage("Could not load mock scores.", 'error');
                renderApp();
            });
        }

        async function saveUserData() {
            if (!isAuthReady || !userId) {
                showMessage("Auth not ready. Cannot save data.", 'error');
                return;
            }
            try {
                const userDocRef = getPrivateDocRef('imat_user_data');
                await setDoc(userDocRef, {
                    examDate: STATE.userData.examDate,
                    studyPlan: STATE.userData.studyPlan,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showMessage("Study plan and exam date saved!");
            } catch (error) {
                console.error("Error saving user data:", error);
                showMessage("Failed to save data.", 'error');
            }
        }

        async function saveMockScore(scoreData) {
            if (!isAuthReady || !userId) {
                showMessage("Auth not ready. Cannot save mock score.", 'error');
                return;
            }
            try {
                const scoresCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'mock_scores');
                await addDoc(scoresCollectionRef, {
                    ...scoreData,
                    timestamp: serverTimestamp()
                });
                showMessage("Mock score saved successfully!");
            } catch (error) {
                console.error("Error saving mock score:", error);
                showMessage("Failed to save mock score.", 'error');
            }
        }


        // --- 4. GEMINI API INTERACTION ---
        
        // FIX: Implemented retry logic with exponential backoff for API calls
        async function exponentialBackoffFetch(fn, retriesLeft = 3, delay = 1000) {
            try {
                return await fn();
            } catch (error) {
                if (retriesLeft > 0) {
                    // console.log(`Retrying API call in ${delay}ms... (Attempts left: ${retriesLeft})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    // Exponential increase in delay plus a random jitter to prevent thundering herd
                    return exponentialBackoffFetch(fn, retriesLeft - 1, delay * 2 + (Math.random() * 500));
                } else {
                    throw error;
                }
            }
        }

        async function generateIMATQuestions(query) {
            const systemPrompt = "You are a highly specialized exam question generator for the International Medical Admissions Test (IMAT). Your task is to generate challenging, multiple-choice questions (5 options: A-E) strictly based on the IMAT syllabus topics (Biology, Chemistry, Physics, Mathematics, Logical Reasoning, General Knowledge). Ensure the correct answer is unambiguously one of the options. Output must be a JSON array.";
            
            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "id": { "type": "STRING", "description": "A unique identifier for the question (e.g., Q1)." },
                        "questionText": { "type": "STRING", "description": "The main question text. Use LaTeX style notation for formulas (e.g. $a = 4 \\text{ m/s}^2$). " },
                        "section": { "type": "STRING", "enum": ["Biology", "Chemistry", "Physics & Mathematics", "Logical Reasoning", "General Knowledge"] },
                        "options": {
                            "type": "OBJECT",
                            "properties": {
                                "A": { "type": "STRING" },
                                "B": { "type": "STRING" },
                                "C": { "type": "STRING" },
                                "D": { "type": "STRING" },
                                "E": { "type": "STRING" }
                            }
                        },
                        "correctAnswer": { "type": "STRING", "enum": ["A", "B", "C", "D", "E"], "description": "The letter corresponding to the correct option." },
                        "explanation": { "type": "STRING", "description": "A detailed explanation for why the chosen option is correct and why others are incorrect. Use LaTeX style notation for formulas." }
                    },
                    required: ["id", "questionText", "section", "options", "correctAnswer", "explanation"]
                }
            };

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                },
            };

            const fetchFn = async () => {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                return response.json();
            };

            try {
                setLoading(true, query.includes('60-question') ? "Crafting 60 unique IMAT questions (30-60 seconds)..." : "Generating custom questions...");
                const result = await exponentialBackoffFetch(fetchFn);
                setLoading(false);
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API returned no content.");
                
                const questions = JSON.parse(jsonText);
                return questions.map((q, index) => ({...q, id: `Q${Date.now() + index}`})); // Ensure unique IDs
            } catch (error) {
                setLoading(false);
                console.error("Error during question generation:", error);
                showMessage("Failed to generate questions. Check console for details. Try again.", 'error');
                return [];
            }
        }
        
        async function startFullMockExam() {
            if (STATE.loading) return;

            // Generate a query for 60 questions based on IMAT breakdown
            const sectionQueries = IMAT_SECTIONS.map(s => `${s.count} questions on ${s.name}`).join(', ');
            const query = `Generate a full ${TOTAL_IMAT_QUESTIONS}-question IMAT mock exam. Provide the following breakdown: ${sectionQueries}.`;

            const questions = await generateIMATQuestions(query);

            if (questions.length === 0) return;

            STATE.currentMock = {
                questions: questions,
                userAnswers: {},
                startTime: Date.now(),
                // Full mock is timed for 100 minutes (60 questions * 1.66 min/q)
                timeLeft: 100 * 60, 
                isFinished: false,
                type: 'mock'
            };

            STATE.currentPage = 'mock_exam';
            STATE.currentQuestionIndex = 0; // Start at the first question
            renderApp();
            startMockTimer();
        }

        async function startAiQuiz(section, count) {
            count = parseInt(count);
            if (STATE.loading || count < 1) return;
            if (count > 30) count = 30; // Enforce max limit for stability

            const query = `Generate ${count} challenging, unique multiple-choice questions for the IMAT section: ${section}.`;

            const questions = await generateIMATQuestions(query);

            if (questions.length === 0) return;

            STATE.currentMock = {
                questions: questions,
                userAnswers: {},
                startTime: Date.now(),
                timeLeft: 9999 * 60, // Untimed
                isFinished: false,
                type: 'quiz'  
            };
            
            STATE.currentPage = 'mock_exam';
            STATE.currentQuestionIndex = 0; // Start at the first question
            renderApp();
        }

        function startQuiz(quizQuestions) {
            if (STATE.loading) return;
            
            STATE.currentMock = {
                questions: quizQuestions,
                userAnswers: {},
                startTime: Date.now(),
                timeLeft: 9999 * 60, // Untimed
                isFinished: false,
                type: 'quiz'  
            };
            
            STATE.currentPage = 'mock_exam';
            STATE.currentQuestionIndex = 0;
            renderApp();
        }


        // --- 5. STUDY PLAN LOGIC ---

        function generatePlan() {
            const examDateStr = STATE.userData.examDate;
            const today = new Date();
            const examDate = new Date(examDateStr);
            
            const diffTime = examDate - today;
            if (diffTime <= 0) {
                showMessage("The exam date has passed or is today! Plan not generated.", 'error');
                STATE.userData.studyPlan = [{ task: "The exam is today or has passed! Time for revision!", days: 0, section: "ALL" }];
                renderApp();
                return;
            }
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const totalWeight = IMAT_SECTIONS.reduce((sum, s) => sum + s.weight, 0);

            let studyPlan = [];
            let daysUsed = 0;

            // Phase 1: Foundation (30% of time)
            let phase1Days = Math.floor(diffDays * 0.3);
            if (phase1Days > 0) {
                studyPlan.push({ days: phase1Days, task: "PHASE 1: Foundation & Diagnostics", section: "ALL" });
                daysUsed += phase1Days;
                
                IMAT_SECTIONS.forEach(s => {
                    const days = Math.max(1, Math.round(phase1Days * (s.weight / totalWeight)));
                    studyPlan.push({ days: days, task: `Core concepts for ${s.name} (${days} days total)`, section: s.name });
                });
            }

            // Phase 2: Comprehensive Review (50% of time)
            let phase2Days = Math.floor(diffDays * 0.5);
            if (phase2Days > 0) {
                studyPlan.push({ days: phase2Days, task: "PHASE 2: Deep Review & Practice", section: "ALL" });
                daysUsed += phase2Days;

                IMAT_SECTIONS.forEach(s => {
                    const days = Math.max(1, Math.round(phase2Days * (s.weight / totalWeight)));
                    studyPlan.push({ days: days, task: `Advanced topics & Quizzes for ${s.name} (${days} days total)`, section: s.name });
                });
            }

            // Phase 3: Mock Exams & Final Revision (Remaining days)
            let phase3Days = diffDays - daysUsed;
            if (phase3Days > 0) {
                studyPlan.push({ days: phase3Days, task: "PHASE 3: Full Mocks & Weak Spot Blitz", section: "ALL" });
                studyPlan.push({ days: Math.max(1, Math.floor(phase3Days / 2)), task: `Full Mock Exams (Timed) & Review`, section: "ALL" });
                studyPlan.push({ days: Math.max(1, Math.ceil(phase3Days / 2)), task: `Intensive review of weakest topics`, section: "ALL" });
            }

            STATE.userData.studyPlan = studyPlan.filter(p => p.days > 0);
            saveUserData();
            renderApp();
        }


        // --- 6. MOCK EXAM TIMER LOGIC ---

        let mockTimerInterval = null;

        function startMockTimer() {
            if (mockTimerInterval) clearInterval(mockTimerInterval);
            if (!STATE.currentMock || STATE.currentMock.type !== 'mock') return; 

            mockTimerInterval = setInterval(() => {
                if (!STATE.currentMock || STATE.currentMock.isFinished) {
                    clearInterval(mockTimerInterval);
                    mockTimerInterval = null;
                    return;
                }

                STATE.currentMock.timeLeft--;

                if (STATE.currentMock.timeLeft <= 0) {
                    clearInterval(mockTimerInterval);
                    finishMockExam();
                    showMessage("Time's up! The mock exam has automatically submitted.", 'error');
                }
                
                // Only re-render the timer display
                const timerEl = document.getElementById('mock-timer-display');
                if (timerEl) {
                    const minutes = Math.floor(STATE.currentMock.timeLeft / 60);
                    const seconds = STATE.currentMock.timeLeft % 60;
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (STATE.currentMock.timeLeft < 600) { // Under 10 minutes left
                        timerEl.classList.add('bg-red-100', 'text-red-700', 'animate-pulse-ring');
                    }
                }
            }, 1000);
        }

        function finishMockExam() {
            if (!STATE.currentMock) return;
            
            const confirmMessage = STATE.currentMock.type === 'mock'
                ? "Are you sure you want to submit the exam? Time left will be forfeited."
                : "Are you sure you want to finish the quiz and view results?";

            if (!confirm(confirmMessage)) return;

            STATE.currentMock.isFinished = true;
            if (STATE.currentMock.type === 'mock') {
                clearInterval(mockTimerInterval);
                mockTimerInterval = null;
            }

            const score = calculateScore(STATE.currentMock);
            STATE.currentMock.score = score;
            
            if (STATE.currentMock.type === 'mock') {
                saveMockScore({
                    questionsCount: STATE.currentMock.questions.length,
                    correct: score.correct,
                    incorrect: score.incorrect,
                    omitted: score.omitted,
                    totalScore: parseFloat(score.totalScore),
                    durationMinutes: Math.floor((Date.now() - STATE.currentMock.startTime) / 60000)
                });
            }

            STATE.currentPage = 'mock_results';
            renderApp();
        }

        // --- 7. RENDERING LOGIC ---

        function navigate(page) {
            // Only allow navigation away from mock_exam if it's finished or if confirmed
            if (STATE.currentPage === 'mock_exam' && STATE.currentMock && !STATE.currentMock.isFinished) {
                if (!confirm("Your current mock is not finished. Are you sure you want to leave and lose your progress?")) {
                    return;
                }
                // Stop timer and clear mock if user confirms leaving
                if (mockTimerInterval) clearInterval(mockTimerInterval);
                STATE.currentMock = null;
            }
            STATE.currentPage = page;
            renderApp();
        }

        function renderNavbar() {
            const container = document.getElementById('nav-container');
            const links = [
                { id: 'dashboard', label: 'Dashboard', icon: 'home' },
                { id: 'mock_setup', label: 'Practice', icon: 'zap' },
                { id: 'study_plan', label: 'Study Planner', icon: 'calendar-check' }
            ];
            
            const isMockActive = STATE.currentMock && !STATE.currentMock.isFinished && STATE.currentPage === 'mock_exam';
            const header = document.getElementById('app-header');
            
            if (isMockActive) {
                // If in mock exam, hide main header and render the compact mock header
                header.classList.add('hidden');
                
                const currentQuestion = STATE.currentMock.questions[STATE.currentQuestionIndex];
                const typeLabel = STATE.currentMock.type === 'mock' ? 'IMAT Mock Exam' : 'Quick Quiz';
                const timeClass = STATE.currentMock.timeLeft < 600 ? 'text-red-700 bg-red-100 border-red-300' : 'text-green-700 bg-green-100 border-green-300';
                
                return `
                    <div class="fixed top-0 left-0 right-0 z-50 py-3 px-6 mock-header flex justify-between items-center border-b border-gray-200">
                        <h1 class="text-xl font-extrabold text-gray-800">${typeLabel} - Q${STATE.currentQuestionIndex + 1}/${STATE.currentMock.questions.length}</h1>
                        <span class="text-md font-semibold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full border border-indigo-300">${currentQuestion.section}</span>
                        <div class="flex items-center space-x-4">
                            ${STATE.currentMock.type === 'mock' ? `
                                <div class="px-3 py-1.5 rounded-lg border font-mono font-bold ${timeClass}">
                                    <i data-lucide="clock" class="h-4 w-4 inline mr-1"></i> 
                                    <span id="mock-timer-display">--:--</span>
                                </div>
                            ` : `<span class="text-gray-500 font-medium">Untimed Quiz</span>`}
                            
                            <button onclick="window.finishMockExam()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-md">
                                <i data-lucide="flag" class="h-4 w-4"></i> Submit
                            </button>
                        </div>
                    </div>
                `;

            } else {
                header.classList.remove('hidden');
            }

            container.innerHTML = links.map(link => `
                <a href="#" onclick="window.navigate('${link.id}')"
                   class="nav-link flex items-center space-x-1 py-2 px-3 transition duration-150 ease-in-out text-gray-600 hover:text-indigo-600 ${STATE.currentPage.startsWith(link.id.split('_')[0]) ? 'active' : ''}">
                   <i data-lucide="${link.icon}" class="h-5 w-5"></i>
                   <span class="hidden sm:inline">${link.label}</span>
                </a>
            `).join('');

            return ''; // Return empty string if rendering regular navbar (already in place)
        }

        function renderApp() {
            const mockHeaderHtml = renderNavbar();
            const view = document.getElementById('app-view');
            
            // If in mock exam and active, place the special header *before* the main content
            if (STATE.currentMock && !STATE.currentMock.isFinished && STATE.currentPage === 'mock_exam') {
                view.innerHTML = mockHeaderHtml + renderMockExam();
            } else {
                // Render main content for other pages
                document.querySelector('.scrollable-content').style.paddingTop = '0'; // Remove padding if not in exam mode
                view.innerHTML = ''; // Clear previous content
                switch (STATE.currentPage) {
                    case 'dashboard': view.innerHTML = renderDashboard(); break;
                    case 'mock_setup': view.innerHTML = renderMockSetup(); break;
                    case 'mock_exam': view.innerHTML = renderMockExam(); break; // Should only happen if finished
                    case 'mock_results': view.innerHTML = renderMockResults(); break;
                    case 'study_plan': view.innerHTML = renderStudyPlan(); break;
                    default: view.innerHTML = renderDashboard();
                }
            }
            
            lucide.createIcons(); // Re-render icons after HTML injection
        }

        // --- View Rendering Functions ---

        function renderDashboard() {
            const today = new Date();
            const examDate = new Date(STATE.userData.examDate);
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            
            const latestScore = STATE.userData.mockScores[0];
            const hasScore = latestScore && latestScore.totalScore !== undefined;

            return `
                <div class="space-y-10">
                    <!-- Hero Section -->
                    <div class="bg-gradient-to-r from-indigo-700 to-violet-700 text-white p-8 sm:p-12 rounded-2xl shadow-2xl shadow-indigo-300">
                        <h2 class="text-5xl font-extrabold mb-3">Your IMAT Success Hub</h2>
                        <p class="text-xl text-indigo-200 max-w-2xl">Access unlimited AI-powered questions, full timed mock exams, and personalized planning.</p>
                        <button onclick="window.navigate('mock_setup')" class="mt-6 bg-white text-indigo-700 font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-100 transition-transform transform hover:scale-105">
                            Start Practice Now
                        </button>
                    </div>

                    <div class="grid md:grid-cols-3 gap-8">
                        <!-- Days Left Card -->
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-indigo-600">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-bold text-gray-700">Days to Exam</h3>
                                <i data-lucide="calendar" class="text-indigo-600 h-6 w-6"></i>
                            </div>
                            <p class="text-6xl font-black text-gray-900 mt-2">${daysLeft > 0 ? daysLeft : '0'}</p>
                            <p class="text-sm text-gray-500 mt-1">Target Date: ${STATE.userData.examDate}</p>
                            <button onclick="window.navigate('study_plan')" class="text-indigo-600 hover:text-indigo-700 text-sm font-bold mt-4 flex items-center">
                                View/Update Plan <i data-lucide="arrow-right" class="inline h-4 w-4 ml-1"></i>
                            </button>
                        </div>
                        
                        <!-- Latest Score Card -->
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-green-600">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-bold text-gray-700">Latest Mock Score</h3>
                                <i data-lucide="award" class="text-green-600 h-6 w-6"></i>
                            </div>
                            <p class="text-6xl font-black text-gray-900 mt-2">${hasScore ? latestScore.totalScore : 'N/A'}</p>
                            <p class="text-sm text-gray-500 mt-1">${hasScore ? `Completed on: ${new Date(latestScore.timestamp).toLocaleDateString()}` : 'No mocks completed yet.'}</p>
                            <button onclick="window.navigate('mock_setup')" class="text-green-600 hover:text-green-700 text-sm font-bold mt-4 flex items-center">
                                Start New Mock <i data-lucide="plus-circle" class="inline h-4 w-4 ml-1"></i>
                            </button>
                        </div>
                        
                        <!-- Total Mocks Card -->
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-yellow-600">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-bold text-gray-700">Mocks Completed</h3>
                                <i data-lucide="list-checks" class="text-yellow-600 h-6 w-6"></i>
                            </div>
                            <p class="text-6xl font-black text-gray-900 mt-2">${STATE.userData.mockScores.length}</p>
                            <p class="text-sm text-gray-500 mt-1">Keep pushing for that top score!</p>
                            <button onclick="document.getElementById('mock-history').scrollIntoView({behavior: 'smooth'})" class="text-yellow-600 hover:text-yellow-700 text-sm font-bold mt-4 flex items-center">
                                View History <i data-lucide="history" class="inline h-4 w-4 ml-1"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mock History Section -->
                    <div id="mock-history" class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <i data-lucide="bar-chart-3" class="h-6 w-6 mr-3 text-indigo-600"></i> Detailed Mock History
                        </h3>
                        ${STATE.userData.mockScores.length > 0 ? `
                            <ul class="divide-y divide-gray-200">
                                ${STATE.userData.mockScores.map(score => `
                                    <li class="py-4 flex justify-between items-center hover:bg-gray-50 transition duration-100 px-2 rounded-lg">
                                        <div>
                                            <p class="font-bold text-xl text-gray-900">Score: <span class="text-green-600">${score.totalScore}</span> / 90.0</p>
                                            <p class="text-sm text-gray-500 mt-1">
                                                Completed: ${new Date(score.timestamp).toLocaleDateString()} at ${new Date(score.timestamp).toLocaleTimeString()}
                                                (${score.questionsCount} Questions, Took ${score.durationMinutes} mins)
                                            </p>
                                        </div>
                                        <div class="text-sm text-right flex space-x-3 font-semibold">
                                            <span class="text-green-600">Correct: ${score.correct}</span>
                                            <span class="text-red-600">Incorrect: ${score.incorrect}</span>
                                            <span class="text-yellow-600">Omitted: ${score.omitted}</span>
                                        </div>
                                    </li>
                                `).join('')}
                            </ul>
                        ` : `
                            <p class="text-gray-500 italic p-4 bg-gray-50 rounded-lg">Complete your first full mock exam to track your progress over time.</p>
                        `}
                    </div>
                </div>
            `;
        }

        function renderMockSetup() {
            const sectionsWithPreGen = IMAT_SECTIONS.filter(s => PRE_GENERATED_QUIZ_QUESTIONS.some(q => q.section === s.name));
            
            const preGeneratedQuizzes = sectionsWithPreGen.map(section => {
                const quizData = PRE_GENERATED_QUIZ_QUESTIONS.filter(q => q.section === section.name);
                if (quizData.length > 0) {
                    return `
                        <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition duration-200">
                            <h4 class="text-xl font-bold text-gray-800">${section.name} Quiz</h4>
                            <p class="text-gray-600 text-sm mb-4">Instant revision quiz (${quizData.length} questions).</p>
                            <button onclick="window.startQuiz(window.PRE_GENERATED_QUIZ_QUESTIONS.filter(q => q.section === '${section.name}'))" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
                                <i data-lucide="zap" class="h-5 w-5 mr-1"></i> Start Instant Quiz
                            </button>
                        </div>
                    `;
                }
                return '';
            }).join('');


            return `
                <div class="max-w-5xl mx-auto space-y-10">
                    <h2 class="text-4xl font-extrabold text-gray-800 border-b pb-4">IMAT Practice & Simulation</h2>
                    
                    <!-- 1. Full AI Mock Exam -->
                    <div class="space-y-4 p-8 bg-indigo-50 rounded-xl border-l-8 border-indigo-600 shadow-2xl">
                        <h3 class="text-3xl font-extrabold text-indigo-800">Full Simulated Mock Exam (60 Q / 100 Min)</h3>
                        <p class="text-xl text-indigo-700">
                            Generate a new, full IMAT mock exam (60 questions) timed exactly like the official test. Your score will be saved to the dashboard history.
                        </p>
                        <div class="flex justify-center pt-4">
                            <button onclick="window.startFullMockExam()" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-10 rounded-xl transition duration-200 ease-in-out shadow-xl shadow-indigo-300 transform hover:scale-[1.02] disabled:opacity-50 flex items-center text-lg"
                                id="start-mock-button"
                                ${STATE.loading ? 'disabled' : ''}>
                                <i data-lucide="play" class="h-6 w-6 mr-3"></i>
                                Start Full ${TOTAL_IMAT_QUESTIONS}-Question Mock
                            </button>
                        </div>
                    </div>

                    <!-- 2. Dynamic AI Quizzes -->
                    <div class="space-y-6 p-8 bg-green-50 rounded-xl border-l-8 border-green-600 shadow-xl">
                        <h3 class="text-3xl font-extrabold text-green-800">Dynamic AI Quick Quizzes (Unlimited Questions)</h3>
                        <p class="text-xl text-green-700">
                            Instantly generate a custom number of unique, untimed questions for focused, deep practice in any section.
                        </p>
                        <div class="grid sm:grid-cols-3 gap-5 items-end">
                            <div class="col-span-1">
                                <label for="quiz-section" class="block text-sm font-bold text-gray-700">Select Section</label>
                                <select id="quiz-section" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-gray-800 font-medium">
                                    ${IMAT_SECTIONS.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-span-1">
                                <label for="quiz-count" class="block text-sm font-bold text-gray-700">Number of Questions (Max 30)</label>
                                <input type="number" id="quiz-count" value="${PRACTICE_QUESTION_COUNT}" min="5" max="30" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 text-gray-800 font-medium">
                            </div>
                            <div class="col-span-1">
                                <button onclick="window.startAiQuiz(document.getElementById('quiz-section').value, document.getElementById('quiz-count').value)"
                                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-105 disabled:opacity-50 flex items-center justify-center"
                                    ${STATE.loading ? 'disabled' : ''}>
                                    <i data-lucide="plus-square" class="h-5 w-5 mr-2"></i> Start Custom Quiz
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Quick Quizzes -->
                    <div class="space-y-6 pt-4">
                        <h3 class="text-3xl font-extrabold text-gray-800 border-b pb-4">Instant Revision Quizzes</h3>
                        <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">
                            ${preGeneratedQuizzes}
                            
                            <!-- Placeholder for future quizzes -->
                            ${IMAT_SECTIONS.filter(s => !sectionsWithPreGen.includes(s)).map(s => `
                                <div class="p-5 bg-gray-100 rounded-xl shadow-md border border-gray-200 flex flex-col justify-center items-center text-center">
                                    <i data-lucide="file-text" class="h-8 w-8 text-gray-500 mb-2"></i>
                                    <p class="text-gray-500 font-bold">${s.name} Quiz (Coming Soon!)</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMockExam() {
            if (!STATE.currentMock) {
                return `<div class="text-center p-8"><p class="text-xl text-gray-500">Practice not started. Please go to the Practice page to begin.</p><button onclick="window.navigate('mock_setup')" class="mt-4 bg-indigo-600 text-white p-3 rounded-lg font-bold">Go to Practice Setup</button></div>`;
            }

            const { questions, userAnswers, type } = STATE.currentMock;
            
            // Get current question index from state
            const currentQuestionIndex = STATE.currentQuestionIndex; 
            const currentQuestion = questions[currentQuestionIndex];
            
            // Create object to track section starting points for the navigator
            const sectionStartIndices = {};
            let lastSection = null;
            questions.forEach((q, index) => {
                if (q.section !== lastSection) {
                    sectionStartIndices[index] = q.section;
                    lastSection = q.section;
                }
            });


            return `
                <div class="grid lg:grid-cols-4 gap-8 pt-20"> <!-- Added padding top to accommodate fixed header -->
                    <!-- Left Sidebar (Navigation) -->
                    <div class="lg:col-span-1 bg-white p-5 rounded-xl shadow-2xl sticky top-24 h-fit border border-gray-100">
                        
                        <h4 class="font-extrabold text-gray-800 text-lg mb-4 border-b pb-2">Question Navigation (${questions.length})</h4>
                        <div class="max-h-[75vh] overflow-y-auto pr-2">
                            <div class="grid grid-cols-4 sm:grid-cols-5 lg:grid-cols-5 gap-2">
                                ${questions.map((q, index) => {
                                    const answer = userAnswers[q.id];
                                    let color = 'bg-gray-100 text-gray-700 border-gray-300';
                                    if (answer) color = 'bg-indigo-600 text-white shadow-md border-indigo-700';
                                    if (index === currentQuestionIndex) color = 'bg-white text-indigo-800 border-4 border-indigo-600 ring-2 ring-indigo-300 shadow-xl';

                                    let sectionLabel = sectionStartIndices[index] ? `
                                        <div class="col-span-full pt-4">
                                            <span class="block text-xs font-bold text-indigo-600 uppercase tracking-wider">${sectionStartIndices[index]}</span>
                                        </div>
                                    ` : '';

                                    return `
                                        ${sectionLabel}
                                        <label>
                                            <input type="radio" name="question-nav" value="${index}" class="hidden" 
                                                ${index === currentQuestionIndex ? 'checked' : ''}
                                                onchange="window.handleQuestionChange(event)"
                                            >
                                            <div class="w-full text-center p-2 rounded-lg cursor-pointer font-bold transition duration-150 transform hover:scale-105 ${color}">
                                                ${index + 1}
                                            </div>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Right Content (Question Area) -->
                    <div class="lg:col-span-3 space-y-6">
                        <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-2xl question-card border-t-8 border-indigo-600">
                            <div class="flex justify-between items-center mb-6 border-b pb-3">
                                <h3 class="text-3xl font-extrabold text-gray-800">Question ${currentQuestionIndex + 1}</h3>
                                <span class="text-lg font-bold text-indigo-700 bg-indigo-100 px-4 py-1 rounded-full border border-indigo-300">${currentQuestion.section}</span>
                            </div>

                            <p class="text-xl text-gray-800 leading-relaxed whitespace-pre-wrap mb-8">${currentQuestion.questionText}</p>

                            <div id="options-container" class="space-y-4">
                                ${Object.entries(currentQuestion.options).map(([key, value]) => `
                                    <label class="flex items-start p-4 rounded-xl cursor-pointer transition duration-150 border-2 shadow-sm 
                                        ${userAnswers[currentQuestion.id] === key ? 'border-indigo-600 bg-indigo-50 text-indigo-900 shadow-md' : 'border-gray-300 bg-white hover:bg-gray-50'}"
                                    >
                                        <input type="radio" name="answer" value="${key}" class="mt-1.5 h-5 w-5 text-indigo-600 focus:ring-indigo-500"
                                            ${userAnswers[currentQuestion.id] === key ? 'checked' : ''}
                                            onchange="window.handleAnswerChange('${currentQuestion.id}', event.target.value)"
                                        >
                                        <span class="ml-3 text-lg font-bold">${key}.</span>
                                        <span class="ml-2 text-lg text-gray-700">${value}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-between items-center mt-6 p-5 bg-white rounded-xl shadow-2xl border border-gray-100">
                            <button onclick="window.prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled' : ''}
                                class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 flex items-center shadow-md">
                                <i data-lucide="chevron-left" class="h-5 w-5 mr-2"></i> Previous
                            </button>
                            
                            <button onclick="window.finishMockExam()"
                                class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200 shadow-xl shadow-red-300 transform hover:scale-105">
                                <i data-lucide="flag" class="h-5 w-5 mr-2"></i> ${type === 'mock' ? 'Submit Exam' : 'Finish Quiz & Review'}
                            </button>

                            <button onclick="window.nextQuestion()" ${currentQuestionIndex === questions.length - 1 ? 'disabled' : ''}
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 flex items-center shadow-md">
                                Next <i data-lucide="chevron-right" class="h-5 w-5 ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderMockResults() {
            if (!STATE.currentMock || !STATE.currentMock.score) {
                return `<div class="text-center p-8"><p class="text-xl text-gray-500">No practice results found.</p><button onclick="window.navigate('mock_setup')" class="mt-4 bg-indigo-600 text-white p-3 rounded-lg font-bold">Start New Practice</button></div>`;
            }

            const score = STATE.currentMock.score;
            const questions = STATE.currentMock.questions;
            const isMock = STATE.currentMock.type === 'mock';
            const maxScore = isMock ? 90.0 : (questions.length * 1.5).toFixed(1);
            const percentage = Math.round((parseFloat(score.totalScore) / 90.0) * 100);

            return `
                <div class="max-w-5xl mx-auto space-y-10">
                    <div class="text-center ${isMock ? 'bg-indigo-100' : 'bg-blue-100'} p-10 rounded-xl shadow-2xl border-t-8 border-indigo-600">
                        <i data-lucide="trophy" class="h-16 w-16 ${isMock ? 'text-indigo-600' : 'text-blue-600'} mx-auto mb-4"></i>
                        <h2 class="text-5xl font-extrabold text-gray-800">${isMock ? 'Full Mock Exam Results' : 'Quiz Review Complete'}</h2>
                        <p class="text-8xl font-black ${percentage >= 60 ? 'text-green-600' : 'text-red-600'} mt-6">${score.totalScore}</p>
                        <p class="text-2xl text-gray-700 mt-2">Total Score (Max ${maxScore})</p>
                    </div>

                    <div class="grid grid-cols-3 gap-6 text-center">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-green-600">
                            <p class="text-4xl font-black text-green-600">${score.correct}</p>
                            <p class="text-md font-semibold text-gray-500">Correct Answers</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-red-600">
                            <p class="text-4xl font-black text-red-600">${score.incorrect}</p>
                            <p class="text-md font-semibold text-gray-500">Incorrect Answers</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-b-4 border-yellow-600">
                            <p class="text-4xl font-black text-yellow-600">${score.omitted}</p>
                            <p class="text-md font-semibold text-gray-500">Omitted Answers</p>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
                        <h3 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">Question-by-Question Review</h3>
                        <div class="space-y-8">
                            ${questions.map((q, index) => {
                                const userAnswer = STATE.currentMock.userAnswers[q.id];
                                const isCorrect = userAnswer === q.correctAnswer;
                                const borderColor = isCorrect ? 'border-green-500' : 'border-red-500';
                                const userText = userAnswer ? `Your Answer: <span class="font-black">${userAnswer}</span>` : 'Omitted';

                                return `
                                    <div class="p-6 rounded-xl shadow-md border-l-4 ${borderColor} bg-gray-50">
                                        <div class="flex justify-between items-start mb-4">
                                            <div>
                                                <p class="font-bold text-xl text-gray-800">Q${index + 1}: ${q.section}</p>
                                                <p class="text-sm text-gray-600">${userText} | Correct Answer: <span class="font-black text-green-700">${q.correctAnswer}</span></p>
                                            </div>
                                            <span class="px-3 py-1 text-sm font-extrabold rounded-full ${isCorrect ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                                ${isCorrect ? 'CORRECT' : 'INCORRECT'}
                                            </span>
                                        </div>
                                        <p class="text-lg text-gray-700 whitespace-pre-wrap mb-4 font-semibold">${q.questionText}</p>
                                        
                                        <div class="mt-4 p-4 bg-indigo-50 rounded-lg">
                                            <p class="font-bold text-indigo-700">Detailed Explanation:</p>
                                            <p class="text-md text-indigo-600 whitespace-pre-wrap mt-1">${q.explanation}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="text-center pt-4">
                        <button onclick="window.navigate('dashboard')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform hover:scale-105">
                            Return to Dashboard
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStudyPlan() {
            const today = new Date();
            const examDate = new Date(STATE.userData.examDate);
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            
            return `
                <div class="max-w-4xl mx-auto space-y-10">
                    <h2 class="text-4xl font-extrabold text-gray-800 border-b pb-4">IMAT Study Planner</h2>

                    <!-- Exam Date Setter -->
                    <div class="p-8 bg-indigo-50 rounded-xl border-l-8 border-indigo-600 shadow-xl">
                        <label for="exam-date" class="block text-xl font-extrabold text-indigo-800 mb-3">
                            Set Your IMAT Exam Date:
                        </label>
                        <input type="date" id="exam-date" value="${STATE.userData.examDate}"
                            onchange="window.handleDateChange(event)"
                            class="p-3 border border-indigo-300 rounded-lg w-full sm:w-2/3 md:w-1/2 focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                        
                        <div class="mt-5 text-gray-700 flex justify-between items-center">
                            <p class="font-bold text-lg">Days Remaining: <span class="text-indigo-700 text-3xl">${daysLeft > 0 ? daysLeft : '0'}</span></p>
                            <button onclick="window.generatePlan()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md disabled:opacity-50" ${STATE.loading ? 'disabled' : ''}>
                                <i data-lucide="refresh-cw" class="inline h-5 w-5 mr-2"></i> Generate/Update Plan
                            </button>
                        </div>
                    </div>
                    
                    <!-- Study Plan Details -->
                    <h3 class="text-3xl font-extrabold text-gray-800 mt-8 mb-4 border-b pb-2">Recommended Study Schedule</h3>
                    
                    ${STATE.userData.studyPlan.length > 0 ? `
                        <div class="space-y-4">
                            ${STATE.userData.studyPlan.map(item => {
                                let color = 'bg-gray-100 border-gray-300 text-gray-800';
                                if (item.section === 'ALL') color = 'bg-indigo-100 border-indigo-600 text-indigo-800 font-bold';
                                if (item.section === 'Biology') color = 'bg-green-100 border-green-600 text-green-800';
                                if (item.section === 'Chemistry') color = 'bg-yellow-100 border-yellow-600 text-yellow-800';
                                if (item.section.includes('Physics')) color = 'bg-red-100 border-red-600 text-red-800';
                                
                                return `
                                    <div class="p-5 rounded-lg border-l-8 ${color} shadow-lg flex justify-between items-center transition duration-150">
                                        <div>
                                            <p class="text-xl font-bold">${item.task}</p>
                                            <p class="text-sm opacity-90">${item.section}</p>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-3xl font-black">${item.days}</span>
                                            <p class="text-sm font-bold">${item.days === 1 ? 'Day' : 'Days'}</p>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="p-8 bg-yellow-50 rounded-lg text-center border-2 border-dashed border-yellow-400 shadow-md">
                            <p class="text-xl text-yellow-800 font-semibold">Set your exam date and click the button above to generate a custom, phased study plan!</p>
                        </div>
                    `}
                </div>
            `;
        }

        // --- 8. EVENT HANDLERS (EXPOSED TO WINDOW) ---

        window.navigate = navigate;
        window.startFullMockExam = startFullMockExam;
        window.startQuiz = startQuiz;
        window.startAiQuiz = startAiQuiz;
        window.generatePlan = generatePlan;
        window.PRE_GENERATED_QUIZ_QUESTIONS = PRE_GENERATED_QUIZ_QUESTIONS; 

        window.handleDateChange = (event) => {
            STATE.userData.examDate = event.target.value;
            // No save here, save happens on explicit generatePlan click
        };

        window.handleAnswerChange = (questionId, value) => {
            if (STATE.currentMock && !STATE.currentMock.isFinished) {
                STATE.currentMock.userAnswers[questionId] = value;
                renderApp(); // Re-render to update selected option highlight and navigator color
            }
        };

        window.handleQuestionChange = (event) => {
            STATE.currentQuestionIndex = parseInt(event.target.value);
            renderApp(); // Re-render to show the new question
        };

        window.nextQuestion = () => {
            if (STATE.currentQuestionIndex < STATE.currentMock.questions.length - 1) {
                STATE.currentQuestionIndex++;
                renderApp();
            }
        };

        window.prevQuestion = () => {
            if (STATE.currentQuestionIndex > 0) {
                STATE.currentQuestionIndex--;
                renderApp();
            }
        };

        window.finishMockExam = finishMockExam;

        // --- 9. BOOTSTRAP ---
        window.onload = () => {
            initFirebase();
            // Initial render called from data listeners when they finish loading
        };

    </script>
</body>
</html>
